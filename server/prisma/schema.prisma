generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  displayName  String
  passwordHash String?
  isActive     Boolean   @default(true)
  roleId       String
  role         Role      @relation(fields: [roleId], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  sessions           Session[]
  oauthAccounts      OAuthAccount[]
  cloudConnections   CloudConnection[]
  deployments        Deployment[]
  auditLogs          AuditLog[]
  services           Service[]       @relation("UserServices")
  workflowRuns       WorkflowRun[]   @relation("UserWorkflowRuns")
  groupMemberships   GroupMember[]
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  permissions String   // JSON array of permission strings
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())

  users                User[]
  federationProviders  FederationProvider[]
}

model OAuthAccount {
  id                String   @id @default(uuid())
  provider          String
  providerAccountId String
  accessToken       String?  // encrypted
  refreshToken      String?  // encrypted
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([provider, providerAccountId])
}

model Session {
  id        String   @id @default(uuid())
  jti       String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model CloudConnection {
  id                String    @id @default(uuid())
  name              String
  provider          String    // aws, gcp, azure
  encryptedCredentials String // AES-256-GCM encrypted JSON
  status            String    @default("pending") // connected, error, pending
  accountIdentifier String    @default("")
  validationMessage String    @default("")
  lastValidatedAt   DateTime?
  metadata          String    @default("{}")  // JSON: region, projectId, subscriptionId, tenantId
  createdById       String
  createdBy         User      @relation(fields: [createdById], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  deployments Deployment[]
}

model Template {
  id           String   @id @default(uuid())
  slug         String   @unique
  name         String
  description  String   @default("")
  provider     String   // aws, gcp, azure
  category     String
  version      String   @default("1.0.0")
  templatePath String
  variables    String   @default("[]") // JSON array of TemplateVariable
  outputs      String   @default("[]") // JSON array of TemplateOutput
  tags         String   @default("[]") // JSON array of strings
  workflow     String?
  hasScaffold  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  deployments      Deployment[]
  services         Service[]
  groupAssignments GroupTemplate[]
}

model Deployment {
  id                String   @id @default(uuid())
  name              String
  status            String   @default("pending")
  templateId        String
  template          Template @relation(fields: [templateId], references: [id])
  cloudConnectionId String
  cloudConnection   CloudConnection @relation(fields: [cloudConnectionId], references: [id])
  variables         String   @default("{}") // JSON
  planOutput        String?
  applyOutput       String?
  destroyOutput     String?
  outputs           String?  // JSON of terraform outputs
  terraformState    String?  // terraform state file content
  errorMessage      String?
  executionMethod   String   @default("local")  // "local" or "github"
  githubRepo        String?  // "owner/repo"
  githubWorkflowId  String?  // workflow ID
  githubRef         String?  // branch/tag ref
  githubRunId       String?  // run ID once dispatched
  githubRunUrl      String?  // URL to GitHub Actions run
  createdById       String
  createdBy         User     @relation(fields: [createdById], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  resource   String
  resourceId String?
  details    String?  // JSON
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  ipAddress  String?
  createdAt  DateTime @default(now())
}

model Service {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  status         String   @default("scaffolding") // scaffolding, active, failed, archived
  templateId     String
  template       Template @relation(fields: [templateId], references: [id])
  githubRepoUrl  String   @default("")
  githubRepoSlug String   @default("")  // "owner/repo"
  parameters     String   @default("{}")
  errorMessage   String?
  createdById    String
  createdBy      User     @relation("UserServices", fields: [createdById], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  workflowRuns   WorkflowRun[]
}

model WorkflowRun {
  id            String    @id @default(uuid())
  serviceId     String
  service       Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  githubRunId   String?
  githubRunUrl  String?
  workflowName  String    @default("")
  status        String    @default("pending") // pending, queued, in_progress, completed, failed
  conclusion    String?
  triggerType   String    @default("scaffold") // scaffold, manual, retry
  triggeredById String
  triggeredBy   User      @relation("UserWorkflowRuns", fields: [triggeredById], references: [id])
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model Group {
  id          String           @id @default(uuid())
  name        String           @unique
  description String           @default("")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  members     GroupMember[]
  templates   GroupTemplate[]
}

model GroupMember {
  id       String   @id @default(uuid())
  groupId  String
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())

  @@unique([groupId, userId])
}

model GroupTemplate {
  id         String   @id @default(uuid())
  groupId    String
  group      Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  templateId String
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@unique([groupId, templateId])
}

model FederationProvider {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  protocol        String   // "oidc" | "saml"
  providerType    String   // "azure-ad" | "google" | "okta" | "custom"
  enabled         Boolean  @default(false)
  config          String   // Encrypted JSON (AES-256-GCM)
  autoCreateUsers Boolean  @default(true)
  defaultRoleId   String
  defaultRole     Role     @relation(fields: [defaultRoleId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
